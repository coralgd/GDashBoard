<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–í—ã–±–æ—Ä –Ω–∏–∫–∞</title>
<link rel="stylesheet" href="hud.css">
</head>
<body>

<div class="hud" style="max-width:500px;margin:80px auto;text-align:center;">
  <h1>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∫</h1>
  <input id="nickInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
  <button id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <p id="error" style="color:red"></p>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  doc, getDoc, setDoc,
  collection, query, where, getDocs
} from
  "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const input = document.getElementById('nickInput');
const btn = document.getElementById('submitBtn');
const error = document.getElementById('error');

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = 'index.html';
    return;
  }

  // üî• –í–û–¢ –û–ù ‚Äî –ì–õ–ê–í–ù–´–ô –§–ò–ö–°
  const userRef = doc(db, 'users', user.uid);
  const snap = await getDoc(userRef);

  if (snap.exists()) {
    const data = snap.data();

    // –ï–°–õ–ò –£–ñ–ï –í–ï–†–ò–§–ù–£–¢ ‚Äî –°–†–ê–ó–£ –ù–ê –ì–õ–ê–í–ù–£–Æ
    if (data.situation === 'verified' && data.nick) {
      location.href = 'main.html';
      return;
    }
  }

  // –ò–ù–ê–ß–ï –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∏–∫–∞
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∏–∫–∞
btn.onclick = async () => {
  const nickValue = input.value.trim();

  if (nickValue.length < 3) {
    error.textContent = '–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π';
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
  const q = query(collection(db,'users'), where('nick','==',nickValue));
  const snap = await getDocs(q);
  if (!snap.empty) {
    error.textContent = '–ù–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç';
    return;
  }

  try {
    await setDoc(doc(db,'users',auth.currentUser.uid), {
      nick: nickValue,
      email: auth.currentUser.email,
      situation: 'not requested'
    }, { merge: true });

    error.style.color = 'cyan';
    error.textContent = '–ù–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.';
  } catch (e) {
    console.error(e);
    error.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∏–∫–∞';
  }
};
</script>

</body>
</html>
